<!-- criação do dia 4, adição da pagina do perfil -->
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <link rel="shortcut icon" href="../assets/imagem/leek.png" type="image/x-icon" />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>39Talk | Perfil</title>

    <link rel="stylesheet" href="./../css/navbarSidebar.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="../js/sessao.js"></script>
    <link rel="stylesheet" href="../testes/perfil.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
  </head>

  <body onload="loadData(), carregarSessao()">
    <div class="menuToggle"></div>
    <div class="sidebar">
      <ul>
        <li class="logo" style="--bg: #33ccba">
          <a href="#">
            <div class="icon">
              <ion-icon name="wifi-outline"></ion-icon>
            </div>
            <div class="text">39Talk</div>
          </a>
        </li>
        <div class="Menulist">
          <li style="--bg: #3367cd">
            <a href="./pg1_home.html">
              <div class="icon"><ion-icon name="home-outline"></ion-icon></div>
              <div class="text">Home</div>
            </a>
          </li>
          <li style="--bg: #de4444" class="active">
            <a href="./pg2_perfil.html">
              <div class="icon">
                <ion-icon name="person-outline"></ion-icon>
              </div>
              <div class="text">Perfil</div>
            </a>
          </li>
          <li style="--bg: #fdc600">
            <a href="./pg4_post.html">
              <div class="icon">
                <ion-icon name="chatbox-outline"></ion-icon>
              </div>
              <div class="text">Posts</div>
            </a>
          </li>
          <li style="--bg: #ffee12">
            <a href="./pg5_jogos.html">
              <div class="icon">
                <ion-icon name="game-controller-outline"></ion-icon>
              </div>
              <div class="text">Jogos</div>
            </a>
          </li>
          <li style="--bg: #ffbacc">
            <a href="./pg6_graficos.html">
              <div class="icon">
                <ion-icon name="bar-chart-outline"></ion-icon>
              </div>
              <div class="text">Gráficos</div>
            </a>
          </li>
        </div>
        <div class="bottom">
          <li style="--bg: #333">
            <a href="#">
              <div class="icon">
                <div class="imgBx">
                  <img id="imgUsuarioSessao" src="https://icons.veryicon.com/png/o/miscellaneous/merchant-pc20/system-settings-9999-20px.png" alt=""/>
                </div>
              </div>
              <div class="text" id="apelidoUsuarioSessao"></div>
            </a>
          </li>
          <li style="--bg: #333">
            <a href="../index.html">
              <div class="icon">
                <ion-icon name="log-out-outline"></ion-icon>
              </div>
              <div class="text">Logout</div>
            </a>
          </li>
        </div>
      </ul>
    </div>

    <div class="centralizar">
      <div class="image-container">
        <img src="../assets/imagem/vocaBanner.png" alt="Background Image" />
      </div>
      <div class="content">
        <main class="main-content">
          <section class="profile-sidebar">
            <img id="imagemPerfil" title="2" alt="Profile Picture" class="imgPerfil" />
            <div class="profile-name">
              <div>
                <span id="profileName"></span>
              </div>
              <button id="buttonEditarPerfil">Editar</button>
            </div>

            <div class="section">
              <pre id="profileInfo" wrap="wrap" style="color: gray; font-style: italic">Escreva sua Bio!</pre>
            </div>
            <div class="section">
              <h3>Atuação no Fandom</h3>
              <div class="text_viz">
                <p id="atuacaoLabel" class="atuacao">Produtor de Conteúdo</p>
              </div>
              <div class="select_viz">
                <!-- Select para a escolha da atuação do usuario na comunidade de vocaloid -->
                <select id="atuacaoSelect" name="atuacao">
                  <option value="1">Fã</option>
                  <option value="2">Produtor de Conteúdo</option>
                  <option value="3">Produtor de Música</option>
                  <option value="4">Jogador</option>
                  <option value="5">Artista</option>
                  <option value="6">Cosplayer</option>
                  <option value="7">Outro</option>
                </select>
              </div>
            </div>
            <div class="section">
              <h3>Vocaloid Favorito</h3>
              <div class="text_viz">
                <p id="volcaloidLabel" class="vocaloid">Hatsune Miku</p>
              </div>
              <div class="select_viz">
                <!-- Select para a escolha do vocaloid favorito do usuario -->
                <select id="vocaloidSelect" name="vocaloid">
                  <option value="1">Meiko</option>
                  <option value="2">Kaito</option>
                  <option value="3">Hatsune Miku</option>
                  <option value="4">Kagamine Rin</option>
                  <option value="5">Kagamine Len</option>
                  <option value="6">Megurine Luka</option>
                </select>
              </div>
            </div>
            <div class="section">
              <h3>Gostos atuais</h3>
              <div id="currentObsessions" class="currentObsessions">
                <!-- Area para o usuario escrever seus gostos atuais -->
                <pre id="gostoAtual" wrap="wrap" style="color: gray; font-style: italic"> #Vocaloid #Musica #Hatsune </pre>
              </div>
            </div>
          </section>
          <section class="main-content column-content">
            <div class="about-me">
              <h2>:: Sobre mim</h2>
              <!-- Area para o usuario escrever um pouco sobre ele -->
              <pre id="aboutMe" wrap="wrap" style="color: gray; font-style: italic">Escreva sobre você!</pre>
            </div>
            <div id="meusPostsContainer" class="posts-container">
              <h2>POSTS</h2>
              <!-- Div para a exibição dos posts feitos pelo usuario logado -->
            </div>
          </section>
        </main>
      </div>
    </div>

  </body>

  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

  <script>
    const idUser = sessionStorage.getItem("ID_USUARIO");

    // criação das constantes dos elementos do perfil:
    const buttonEditarPerfil = document.querySelector("#buttonEditarPerfil");
    const profileName = document.querySelector("#profileName");
    const profileInfo = document.querySelector("#profileInfo");
    const aboutMe = document.querySelector("#aboutMe");
    const obsessions = document.querySelector("#currentObsessions");
    const fandom = document.querySelector("#atuacaoLabel");
    const fand_select = document.querySelector("#atuacaoSelect");
    const vocaloid = document.querySelector("#volcaloidLabel");
    const voc_select = document.querySelector("#vocaloidSelect");
    const gostoAtual = document.querySelector("#gostoAtual");
    const imagemProf = document.querySelector("#imagemPerfil");
    const imgUsuarioSessao = document.querySelector("#imgUsuarioSessao");
    const text_viz = document.querySelectorAll(".text_viz");
    const select_viz = document.querySelectorAll(".select_viz");
    // end elementos;

    // Criação de variaveis para
    var VOCALOIDlist = 0;
    var MUSICAlist = 0;
    var CRYPTONlist = 0;
    var MIKUlist = 0;
    var KAITOlist = 0;
    var MEIKOlist = 0;
    var LUKAlist = 0;
    var LENlist = 0;
    var RINlist = 0;
    var PROSEKAIlist = 0;
    var OUTROSlist = 0;

    // Database Load
    function loadData() {
      fetch("/perfil/verificar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          iduserServer: idUser,
        }),
      })
        .then(function (resposta) {
          resposta.json().then(function (resposta) {
            // console.log("resposta: ", resposta);
            // console.log("Dados recebidos: ", JSON.stringify(resposta));
            perfil = resposta[0];
            // console.log(perfil);
            // console.log(`perfilap ${perfil.apelido}`);
            profileName.innerHTML = perfil.apelido;
            profileInfo.innerHTML = perfil.resumo;
            gostoAtual.innerHTML = perfil.gosto;
            aboutMe.innerHTML = perfil.sobre;
            fand_select.selectedIndex = resposta[0].fkatuacao - 1;
            console.log(fand_select.selectedIndex);
            fandom.innerHTML = fand_select.options[fand_select.selectedIndex].text;
            voc_select.selectedIndex = resposta[0].fkvocaloid - 1;
            vocaloid.innerHTML = voc_select.options[voc_select.selectedIndex].text;
            imagemProf.setAttribute("src", perfil.imagem);
            sessionStorage.IMAGEM_USUARIO = perfil.imagem;
            imgUsuarioSessao.src = `${perfil.imagem}`;
          });
        })
        .catch(function (resposta) {
          "";
          console.log(`#ERRO: ${resposta}`);
        });
      fetch("/post/listarMeusPosts", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          iduserServer: idUser,
        }),
      })
        .then(function (resposta) {
          resposta.json().then(function (resposta) {
            // console.log("resposta: ", resposta);
            // console.log("Dados recebidos: ", JSON.stringify(resposta));
            var ContadorAuxiliar = 0;

            for (let i = 0; i < resposta.length; i++) {
              var post = resposta[i];
              var tempo = post.datahora;
              var time = formatData(tempo);
              var tema = post.tema;
              ContadorAuxiliar++;
              meusPostsContainer.innerHTML += `
              <div class="post-container">
                          <h3>${post.titulo}</h3>
                          <p>${post.texto}</p>
                          <div class="post-meta">
                              <div class="date">Postado ${time}</div>
                          </div>
              </div>

        `;

              if (tema == "VOCALOID") {
                VOCALOIDlist++;
              } else if (tema == "MUSICA") {
                MUSICAlist++;
              } else if (tema == "CRYPTON") {
                CRYPTONlist++;
              } else if (tema == "MIKU") {
                MIKUlist++;
              } else if (tema == "KAITO") {
                KAITOlist++;
              } else if (tema == "MEIKO") {
                MEIKOlist++;
              } else if (tema == "LUKA") {
                LUKAlist++;
              } else if (tema == "LEN") {
                LENlist++;
              } else if (tema == "RIN") {
                RINlist++;
              } else if (tema == "PROSEKAI") {
                PROSEKAIlist++;
              } else {
                OUTROSlist++;
              }
            }
          });
        })
        .catch(function (resposta) {
          "";
          console.log(`#ERRO: ${resposta}`);
        });
    }

    // sidebar:
    let menuToggle = document.querySelector(".menuToggle");
    let sidebar = document.querySelector(".sidebar");
    menuToggle.onclick = function () {
      menuToggle.classList.toggle("active");
      sidebar.classList.toggle("active");
    };

    let Menulist = document.querySelectorAll(".Menulist li");
    function activeLink() {
      Menulist.forEach((item) => item.classList.remove("active"));
      this.classList.add("active");
    }
    Menulist.forEach((item) => item.addEventListener("click", activeLink));

    // editar perfil:
    function editarPerfil() {
      if (buttonEditarPerfil.innerHTML === "Editar") {
        buttonEditarPerfil.innerHTML = "Salvar";
        profileInfo.style.color = "black";
        profileInfo.style.fontStyle = "normal";
        aboutMe.style.color = "black";
        aboutMe.style.fontStyle = "normal";

        profileName.classList.add("editavel");
        profileInfo.classList.add("editavel");
        aboutMe.classList.add("editavel");
        obsessions.classList.add("editavel");
        select_viz[0].classList.add("editavel");
        select_viz[1].classList.add("editavel");

        profileName.contentEditable = true;
        profileInfo.contentEditable = true;
        aboutMe.contentEditable = true;
        obsessions.contentEditable = true;

        select_viz[0].style.display = "block";
        select_viz[1].style.display = "block";
        text_viz[0].style.display = "none";
        text_viz[1].style.display = "none";
      } else {
        buttonEditarPerfil.innerHTML = "Editar";

        profileName.classList.remove("editavel");
        profileInfo.classList.remove("editavel");
        aboutMe.classList.remove("editavel");
        obsessions.classList.remove("editavel");
        select_viz[0].classList.remove("editavel");
        select_viz[1].classList.remove("editavel");

        profileName.contentEditable = false;
        profileInfo.contentEditable = false;
        aboutMe.contentEditable = false;
        obsessions.contentEditable = false;

        select_viz[0].style.display = "none";
        select_viz[1].style.display = "none";
        text_viz[0].style.display = "block";
        text_viz[1].style.display = "block";

        vocaloid.innerHTML = voc_select.options[voc_select.selectedIndex].text;
        fandom.innerHTML = fand_select.options[fand_select.selectedIndex].text;

        if (profileInfo.innerHTML == "") {
          profileInfo.style.color = "gray";
          profileInfo.style.fontStyle = "italic";
        }

        if (aboutMe.innerHTML == "") {
          aboutMe.style.color = "gray";
          aboutMe.style.fontStyle = "italic";
        }

        // envia os dados para o banco de dados
        fetch("/perfil/atualizar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            apelidoServer: profileName.textContent,
            resumoServer: profileInfo.innerHTML,
            gostoServer: obsessions.querySelector("pre").textContent,
            sobreServer: aboutMe.innerHTML,
            vocaloidServer: voc_select.value,
            atuacaoServer: fand_select.value,
            imagemServer: voc_select.value,
            idUserServer: idUser,
          }),
        })
          .then(function (resposta) {
            // console.log("resposta: ", resposta);
            sessionStorage.APELIDO_USUARIO = profileName.textContent;
            window.location.reload();
          })
          .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
          });
      }
    }

    buttonEditarPerfil.addEventListener("click", editarPerfil);

    function formatData(isoDate) {
      const date = new Date(isoDate);

      // Array com os nomes dos meses
      const months = ["Janeiro", "Fevereiro", "Março", "April", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Decembro"];

      // Constantes para pegar o tempo
      const month = months[date.getMonth()];
      const year = date.getFullYear();
      let hours = date.getHours();
      const minutes = date.getMinutes();

      // Formata os minutos para garantir dois dígitos
      const formattedMinutes = minutes < 10 ? "0" + minutes : minutes;

      // Monta a data formatada
      return ` às ${hours}:${formattedMinutes} de ${month} de ${year}`;
    }
  </script>
</html>
